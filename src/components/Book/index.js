import React, { Fragment, useEffect, useState } from "react";
import "./BookDetail.scss";
import Breadcrumb from "react-bootstrap/Breadcrumb";
import Container from "react-bootstrap/Container";
import Row from "react-bootstrap/Row";
import Col from "react-bootstrap/Col";
import { BsFillStarFill, BsFillHeartFill } from "react-icons/bs";
import { IoCheckmarkSharp, IoPersonCircleSharp } from "react-icons/io5";
import { FaGreaterThanEqual } from "react-icons/fa";
import Table from "react-bootstrap/Table";
import Toast from "react-bootstrap/Toast";
import { Button } from "react-bootstrap";
import BookItem from "../Home/Books/BookItem";
import Slider from "react-slick";
import ImageGallery from "react-image-gallery";
import "react-image-gallery/styles/css/image-gallery.css";
import { useParams } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";
import {
  clearErrorsDetails,
  getProductDetails,
} from "../../redux/features/product/productDetailsSlice";
import Loading from "../../more/Loader";
import {
  clearErrorsReview,
  newReview,
  resetStateReview,
} from "../../redux/features/product/newReviewSlice";
import { toast, ToastContainer } from "react-toastify";
import { Rating } from "@material-ui/lab";
import { addItemsToCart } from "../../redux/features/cart/cartSlice";
import { addItemsToFavourite } from "../../redux/features/favourite/favouriteSlice";
import { numberWithCommas } from "../../more/FormatNumber";

const Books = [
  {
    title: "Ra B·ªù Su·ªëi Ng·∫Øm Hoa K√®n H·ªìng",
    author: "Nguy·ªÖn Nh·∫≠t √Ånh",
    img: "https://drive.google.com/uc?id=1evMkN-8Yzk2FL51iREJZXawvg1-CpMVc",
    price: "100.500 ƒë",
  },
  {
    title: "L√†m B·∫°n V·ªõi B·∫ßu Tr·ªùi",
    author: "Nguy·ªÖn Nh·∫≠t √Ånh",
    img: "https://drive.google.com/uc?id=1f81BHRFLAE1yEddPLdRUJO3jXJ2_SQPS",
    price: "150.500 ƒë",
  },
  {
    title: "Ch√∫c M·ªôt Ng√†y T·ªët L√†nh",
    author: "Nguy·ªÖn Nh·∫≠t √Ånh",
    img: "https://drive.google.com/uc?id=1qiStbESBEiBavZGEgTvcvoI7UHW9MKEy",
    price: "90.500 ƒë",
  },
  {
    title: "Ng√†y X∆∞a C√≥ M·ªôt Chuy·ªán T√¨nh",
    author: "Nguy·ªÖn Nh·∫≠t √Ånh",
    img: "https://drive.google.com/uc?id=1iljqkkb1hT_FPSzkZJc0y5XtwNfzNL1K",
    price: "111.500 ƒë",
  },
  {
    title: "T√†n L·ª≠a",
    author: "Shizukui Shusuke",
    img: "https://drive.google.com/uc?id=1SNwfEQMgarJBqvFH2ECYpEIxPGdGR1FG",
    price: "111.500 ƒë",
  },
  {
    title: "C·∫£m ∆†n Ng∆∞·ªùi L·ªõn",
    author: "Nguy·ªÖn Nh·∫≠t √Ånh",
    img: "https://drive.google.com/uc?id=1SFgK4XIgGATHp0hauLyMf_Ccbs-sDuEj",
    price: "111.500 ƒë",
  },
  {
    title: "Chuy·ªán K·ªÉ R·∫±ng C√≥ N√†ng V√† T√¥i",
    author: "Nhi·ªÅu t√°c gi·∫£",
    img: "https://drive.google.com/uc?id=15eeAUNLISuTCIDK_YRiSQwCWglfJbHZW",
    price: "111.500 ƒë",
  },
  {
    title: "C·ªë ƒê·ªãnh M·ªôt ƒê√°m M√¢y",
    author: "Nguy·ªÖn Ng·ªçc T∆∞",
    img: "https://drive.google.com/uc?id=1DRQUMkxDzs4ldQwJ0X746gDL9boMVW_Q",
    price: "111.500 ƒë",
  },
];

export default function BookDetail() {
  function AddButton() {
    const addToCart = (id) => {
      dispatch(addItemsToCart(id, 1));
      toast.success(
        `S√°ch ${product.name} ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!`,
        {
          position: "bottom-center",
          autoClose: 5000,
          hideProgressBar: false,
          closeOnClick: true,
          pauseOnHover: true,
          draggable: true,
          progress: undefined,
        }
      );
    };

    return (
      <div>
        <button
          type="button"
          onClick={() => addToCart(product._id)}
          className="book-add-btn btn border rounded text-center fs-6 text-uppercase p-3 ps-4 pe-4 fw-bold"
        >
          Th√™m v√†o gi·ªè h√†ng
        </button>
      </div>
    );
  }

  function AddFavorite() {
    const [show, setShow] = useState(false);
    const addToFavourite = (id) => {
      dispatch(addItemsToFavourite(id));
      toast.success(
        `S√°ch ${product.name} ƒë√£ ƒë∆∞·ª£c th√™m v√†o y√™u th√≠ch th√†nh c√¥ng!`,
        {
          position: "bottom-center",
          autoClose: 5000,
          hideProgressBar: false,
          closeOnClick: true,
          pauseOnHover: true,
          draggable: true,
          progress: undefined,
        }
      );
    };

    return (
      <div>
        <button
          type="button"
          onClick={() => addToFavourite(product._id)}
          className="book-like-btn border border-2 rounded text-center align-middle p-1 ps-3 pe-3"
        >
          <i className="book-like-icon text-danger fs-6">
            {" "}
            <BsFillHeartFill />{" "}
          </i>
          Th√™m v√†o y√™u th√≠ch
        </button>
      </div>
    );
  }

  let settings = {
    infinite: false,
    speed: 1000,
    arrows: true,
    slidesToShow: 5,
    slidesToScroll: 4,

    responsive: [
      {
        breakpoint: 960,
        settings: {
          slidesToShow: 3,
          slidesToScroll: 1,
        },
      },
      {
        breakpoint: 480,
        settings: {
          slidesToShow: 1,
          slidesToScroll: 1,
        },
      },
    ],
  };

  const { id } = useParams();
  const dispatch = useDispatch();
  const { loading, error, product } = useSelector(
    (state) => state.productDetails
  );
  const { success, error: reviewError } = useSelector(
    (state) => state.newReview
  );
  //   add review
  // const [quantity, setQuantity] = useState(1);
  // const [open, setOpen] = useState(false);
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState("");
  // const increaseQuantity = () => {
  //   if (product.Stock <= quantity) return;

  //   const qty = quantity + 1;
  //   setQuantity(qty);
  // };
  // const decreaseQuantity = () => {
  //   if (1 >= quantity) return;

  //   const qty = quantity - 1;
  //   setQuantity(qty);
  // };
  // const submitReviewToggle = () => {
  //   open ? setOpen(false) : setOpen(true);
  // };
  const { user } = useSelector((state) => state.user);
  const reviewSubmitHandler = () => {
    const myForm = new FormData();

    myForm.set("rating", rating);
    myForm.set("comment", comment);
    myForm.set("bookId", id);
    console.log(comment, rating);
    console.log(myForm);
    dispatch(newReview(myForm));
    // );
    // console.log(user);
    // setOpen(false);
  };
  // done
  //   console.log(product);
  useEffect(() => {
    dispatch(getProductDetails(id));
  }, [id]);
  }, [dispatch]);

  useEffect(() => {
    if (error) {
      alert(error);
      dispatch(clearErrorsDetails());
    }
    if (!success && reviewError) {
      toast.error(`${reviewError}`, {
        position: "top-center",
        autoClose: 5000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        progress: undefined,
      });
      console.log(reviewError);
      dispatch(clearErrorsReview());
      dispatch(getProductDetails(id));
    } else if (success) {
      toast.success("Th√™m review s√°ch th√†nh c√¥ng! üéä", {
        position: "bottom-center",
        autoClose: 5000,
        hideProgressBar: false,
        closeOnClick: true,
        pauseOnHover: true,
        draggable: true,
        progress: undefined,
      });
      console.log(success);
      dispatch(resetStateReview());
      dispatch(getProductDetails(id));
    }
  }, [dispatch, error, alert, reviewError, success]);

  const [Images, setImages] = useState([]);

  useEffect(() => {
    if (product.images && product.images.length > 0) {
      let images = [];

      product.images.map((item, i) => {
        images.push({
          original: item.url,
          thumbnail: item.url,
        });
      });
      setImages(images);
    }
  }, [product.images]);

  // let images = [];
  // product &&
  //   product.forEach((item) => {
  //     images.push({
  //       original: item.url,
  //       thumbnail: item.url,
  //     });
  //   });

  return (
    <Fragment>
      {loading ? (
        <Loading />
      ) : (
        <div className="book-container container-fluid">
          <div className="book-breadcrumb ms-5 mt-2">
            <Breadcrumb>
              <Breadcrumb.Item href="/">Trang ch·ªß</Breadcrumb.Item>
              <Breadcrumb.Item href="/categories" className="text-capitalize">
                Danh m·ª•c s√°ch
              </Breadcrumb.Item>
              <Breadcrumb.Item active className="text-capitalize">
                {product.name}
              </Breadcrumb.Item>
            </Breadcrumb>
          </div>
          <div className="book-main-container pb-5">
            <Container>
              <Row>
                <Col xs={6} md={4}>
                  <div className="book-main-img">
                    {/* <ImageGallery 
                      items={[
                        {
                          original: "https://picsum.photos/id/1018/1000/600/",
                          // thumbnail: "https://picsum.photos/id/1018/250/150/"
                        },
                        {
                          original: "https://picsum.photos/id/1015/1000/600/",
                          // thumbnail: "https://picsum.photos/id/1015/250/150/"
                        },
                        {
                          original: "https://picsum.photos/id/1019/1000/600/",
                          // thumbnail: "https://picsum.photos/id/1019/250/150/"
                        }
                      ]}
                      /> */}
                    {/* <ImageGallery
                      items={product.images &&
                        product.images.map((prop) => (
                          {original: prop.url, thumbnail: prop.url}
                        ))}
                    /> */}
                    <ImageGallery items={Images} />
                  </div>
                </Col>
                <Col xs={12} md={8}>
                  <div className="book-main-intro ms-5">
                    <div className="book-main-title">
                      <h3 className="book-title text-capitalize">
                        {product.name}
                      </h3>
                      <div className="book-author-container d-flex">
                        <div className="book-author me-5 mb-2">
                          <span>T√°c gi·∫£:</span>
                          <span className="book-author-name ms-1 me-2">
                            {product.author}
                          </span>
                        </div>
                        <div className="book-publish">
                          <span>Ph√°t h√†nh:</span>
                          <span className="book-publish-name ms-1 me-2">
                            {product.publisher}
                          </span>
                        </div>
                      </div>
                      <div className="book-rating border-bottom pb-2">
                        {/* <i className="book-item-rating text-warning me-1">
                          <BsFillStarFill />
                        </i>
                        <i className="book-item-rating text-warning me-1">
                          <BsFillStarFill />
                        </i>
                        <i className="book-item-rating text-warning me-1">
                          <BsFillStarFill />
                        </i>
                        <i className="book-item-rating text-warning me-1">
                          <BsFillStarFill />
                        </i>
                        <i className="book-item-rating text-warning me-1">
                          <BsFillStarFill />
                        </i> */}
                        <Rating value={product.ratings} size="large" readOnly />
                        <p className="d-inline ms-2 align-middle">
                          <i>{product.numOfReviews} ƒë√°nh gi√°</i>
                        </p>
                      </div>
                    </div>
                    <div className="book-main-price mt-2 d-flex align-items-center border-bottom pb-2">
                      <div className="book-price-container flex-grow-1">
                        <div className="book-price-current">
                          <span className="book-current fs-1">
                            {/* {numberWithCommas(product.price)}{" "} */}
                            <sup>
                              <u>ƒë</u>
                            </sup>
                          </span>
                        </div>
                        <div className="book-price-cover-container d-flex">
                          <div className="book-price-cover">
                            <span>Gi√° b√¨a:</span>
                            <span className="book-cover ms-2">
                              80.000{" "}
                              <sup>
                                <u>ƒë</u>
                              </sup>
                            </span>
                          </div>
                          <div className="book-price-sale">
                            <span className="book-sale-name ms-5">
                              Ti·∫øt ki·ªám:
                            </span>
                            <span className="book-sale ms-2 fw-bold">
                              12.000{" "}
                              <sup>
                                <u>ƒë</u>
                              </sup>{" "}
                              (-15%)
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="book-add-button flex-shrink-0 d-grid gap-2 d-md-flex justify-content-md-end col-4">
                        <AddButton />
                      </div>
                    </div>
                    <div className="book-main-check mt-3">
                      <p className="book-check">
                        <i className="book-check-icon text-success">
                          <IoCheckmarkSharp />{" "}
                        </i>
                        B·ªçc plastic mi·ªÖn ph√≠
                      </p>
                      <p className="book-check">
                        <i className="book-check-icon text-success">
                          <IoCheckmarkSharp />{" "}
                        </i>
                        Giao h√†ng mi·ªÖn ph√≠ trong n·ªôi th√†nh TP. HCM v·ªõi ƒë∆°n h√†ng
                        <i className="book-compare-icon text-success fs-6">
                          {" "}
                          <FaGreaterThanEqual />{" "}
                        </i>
                        <span className="text-success fw-bold">150.000ƒë</span>
                      </p>
                      <p className="book-check">
                        <i className="book-check-icon text-success">
                          <IoCheckmarkSharp />{" "}
                        </i>
                        Giao h√†ng mi·ªÖn ph√≠ to√†n qu·ªëc v·ªõi ƒë∆°n h√†ng
                        <i className="book-compare-icon text-success fs-6">
                          {" "}
                          <FaGreaterThanEqual />{" "}
                        </i>
                        <span className="text-success fw-bold">250.000ƒë</span>
                      </p>
                      <div className="book-like-button">
                        <AddFavorite />
                      </div>
                    </div>
                  </div>
                </Col>
              </Row>
            </Container>
          </div>
          <div className="book-intro ms-5 me-5">
            <h4 className="book-intro-title text-capitalize pb-2">
              Gi·ªõi thi·ªáu s√°ch
            </h4>
            <h5 className="book-name-title text-capitalize pt-2">
              {product.name}
            </h5>
            <p className="book-intro-content">{product.description}</p>
          </div>
          <div className="book-detail ms-5 me-5 pt-3">
            <h4 className="book-detail-title text-capitalize pb-2">
              Th√¥ng tin chi ti·∫øt
            </h4>
            <Table striped bordered hover responsive>
              {/* <thead>
                    <tr>
                        <th>#</th>
                        <th>Table heading</th>
                        <th>Table heading</th>
                        <th>Table heading</th>
                        <th>Table heading</th>
                        <th>Table heading</th>
                        <th>Table heading</th>
                    </tr>
                    </thead> */}
              <tbody>
                <tr>
                  <td>T√°c gi·∫£</td>
                  <td>{product.author}</td>
                </tr>
                <tr>
                  <td>C√¥ng ty ph√°t h√†nh</td>
                  <td>{product.publisher}</td>
                </tr>
                <tr>
                  <td>Lo·∫°i b√¨a</td>
                  <td>B√¨a m·ªÅm</td>
                </tr>
                <tr>
                  <td>S·ªë trang</td>
                  <td>{product.pageNumber}</td>
                </tr>
                <tr>
                  <td>K√≠ch th∆∞·ªõc</td>
                  <td>12 x 20 cm</td>
                </tr>
                <tr>
                  <td>Tr·ªçng l∆∞·ª£ng</td>
                  <td>210 gram</td>
                </tr>
                <tr>
                  <td>ƒê√£ b√°n</td>
                  <td>{product.Sold}</td>
                </tr>
                <tr>
                  <td>Ng√†y ph√°t h√†nh</td>
                  <td>01/06/2017</td>
                </tr>
                <tr>
                  <td>Danh m·ª•c</td>
                  <td>{product.category}</td>
                </tr>
              </tbody>
            </Table>
            <div className="book-add-button text-center">
              <AddButton />
            </div>
          </div>
          <div className="book-comment ms-5 me-5">
            <h4 className="book-comment-title text-capitalize pb-2 mt-5">
              ƒê√°nh gi√°
            </h4>
            <div className="book-comment-rating">
              {/* <i className="book-item-rating text-warning me-1">
                <BsFillStarFill />
              </i>
              <i className="book-item-rating text-warning me-1">
                <BsFillStarFill />
              </i>
              <i className="book-item-rating text-warning me-1">
                <BsFillStarFill />
              </i>
              <i className="book-item-rating text-warning me-1">
                <BsFillStarFill />
              </i>
              <i className="book-item-rating text-warning me-1">
                <BsFillStarFill />
              </i>
              <p className="d-inline ms-2 align-middle">
                5.0 <i>(4 ƒë√°nh gi√°)</i>
              </p> */}
              <Rating
                onChange={(e) => setRating(e.target.value)}
                value={rating}
                size="large"
                className="book-item-rating"
                name="rating"
              />
            </div>
            <p className="book-comment-number mt-2">
              {product.numOfReviews} b√¨nh lu·∫≠n
            </p>
            <form>
              <div className="book-comment-write d-flex">
                <div className="book-comment-avatar flex-shrink-0 fs-1">
                  <IoPersonCircleSharp />
                </div>
                <div className="book-comment-field flex-grow-1 ms-3 d-flex align-items-end flex-column">
                  <textarea
                    id="book-cmt-field"
                    className="w-100 ps-2"
                    name="comment"
                    placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n"
                    rows={3}
                    value={comment}
                    onChange={(e) => setComment(e.target.value)}
                  ></textarea>
                  <div className="book-comment-button mt-2 mb-4">
                    <Button
                      //   type="submit"
                      className="book-cmt-btn border rounded text-center fs-6"
                      onClick={reviewSubmitHandler}
                    >
                      ƒêƒÉng
                    </Button>
                  </div>
                </div>
              </div>
            </form>
            <div className="book-comment-others">
              {/* {product.reviews &&
                product.reviews.map((item, i) => {
                  <div className="book-comment-user d-flex border-top">
                    <div className="book-comment-avatar flex-shrink-0 fs-1">
                      <IoPersonCircleSharp />
                    </div>
                    <div className="book-comment-container flex-grow-1 ms-3 mt-4">
                      <div className="book-comment-userinfo d-flex">
                        <div className="book-comment-name w-100 fw-bold">
                          <p>{item.name}</p>
                        </div>
                        <div className="book-comment-date flex-shrink-1 text-secondary fs-6">
                          <p>{item.time}</p>
                        </div>
                      </div>
                      <div className="book-comment-content">
                        <p>{item.comment}</p>
                      </div>
                    </div>
                  </div>;
                })} */}
              {product.reviews &&
                product.reviews.map((item, i) => (
                  <div className="book-comment-user d-flex border-top" key={i}>
                    <div className="book-comment-avatar flex-shrink-0 fs-1">
                      <IoPersonCircleSharp />
                    </div>
                    <div className="book-comment-container flex-grow-1 ms-3 mt-4">
                      <div className="book-comment-userinfo d-flex">
                        <div className="book-comment-name w-100 fw-bold">
                          <p>{item.name}</p>
                        </div>
                        <Rating value={item.rating} size="large" readOnly />
                        <div className="book-comment-date flex-shrink-1 text-secondary fs-6">
                          <p>{item.time}</p>
                        </div>
                      </div>
                      <div className="book-comment-content">
                        <p>{item.comment}</p>
                      </div>
                    </div>
                  </div>
                ))}
              {/* <div className="book-comment-user d-flex border-top">
                <div className="book-comment-avatar flex-shrink-0 fs-1">
                  <IoPersonCircleSharp />
                </div>
                <div className="book-comment-container flex-grow-1 ms-3 mt-4">
                  <div className="book-comment-userinfo d-flex">
                    <div className="book-comment-name w-100 fw-bold">
                      <p>Nguy·ªÖn VƒÉn B</p>
                    </div>
                    <div className="book-comment-date flex-shrink-1 text-secondary fs-6">
                      <p>04/04/2022</p>
                    </div>
                  </div>
                  <div className="book-comment-content">
                    <p>B√†i vi·∫øt r·∫•t hay!</p>
                  </div>
                </div>
              </div>
              <div className="book-comment-user d-flex border-top">
                <div className="book-comment-avatar flex-shrink-0 fs-1">
                  <IoPersonCircleSharp />
                </div>
                <div className="book-comment-container flex-grow-1 ms-3 mt-4">
                  <div className="book-comment-userinfo d-flex">
                    <div className="book-comment-name w-100 fw-bold">
                      <p>Nguy·ªÖn VƒÉn A</p>
                    </div>
                    <div className="book-comment-date flex-shrink-1 text-secondary fs-6">
                      <p>03/04/2022</p>
                    </div>
                  </div>
                  <div className="book-comment-content">
                    <p>M√¨nh nh·∫•t ƒë·ªãnh s·∫Ω mua cu·ªën s√°ch n√†y v·ªÅ ƒë·ªçc.</p>
                  </div>
                </div>
              </div> */}
            </div>
          </div>
          <div className="book-other ms-5 me-5 pt-3">
            <h4 className="book-other-title text-capitalize pb-2 mt-5">
              S√°ch c√πng danh m·ª•c
            </h4>
            <Slider className="first-books" {...settings}>
              {Books.map((item, index) => {
                return (
                  <BookItem
                    key={index}
                    title={item.title}
                    author={item.author}
                    img={item.img}
                    price={item.price}
                  />
                );
              })}
            </Slider>
            <div className="book-see-more text-center mt-0">
              <Button className="book-see-more-button" variant="primary">
                Xem th√™m &rarr;
              </Button>
            </div>
          </div>

          <ToastContainer
            position="top-center"
            autoClose={5000}
            hideProgressBar={false}
            newestOnTop={false}
            closeOnClick
            rtl={false}
            pauseOnFocusLoss
            draggable
            pauseOnHover
          />
        </div>
      )}
    </Fragment>
  );
}
